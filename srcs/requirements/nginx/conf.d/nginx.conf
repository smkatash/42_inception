events {
	worker_connections 768;
}

http {
		#upstream defines a cluster that you can proxy requests to,
		# for defining a web server cluster for load balancing.
		upstream wordpress {
			server wordpress:9000;
		}
		
		server {
			listen 80;
			listen [::]:80;
			server_name ktashbae.42.fr www.ktashbae.42.fr;
			# redirect all HTTP requests to HTTPS with a 301 Moved 
			# permanently response.
			return 301 https://$host$request_uri;
		}
		# Server configuration
		server {
			listen 443 ssl;
			listen [::]:443 ssl;

			server_name ktashbae.42.fr www.ktashbae.42.fr;
			include  /etc/nginx/mime.types;
			# Root directory of wordpress to serve
			root /var/www/wordpress/;
			# Add index.php to the list if you are using PHP
			index index.php index.html index.htm;
			# Self signed certs generated by the ssl-cert package
			# && indicate locations of SSL key files.
			ssl_certificate /etc/ssl/certs/ktashbae.crt;
			ssl_certificate_key /etc/ssl/private/ktashbae.key;
			ssl_protocols TLSv1.2 TLSv1.3;

			# First attempt to serve request as file, then
			# as directory, then fall back to displaying a 404.
			location / {
				try_files $uri $uri/ =404;
			}

			# pass the PHP scripts to FastCGI server listening on localhost:9000
			location ~ \.php$ {
				# this directive defines a regular expression with two captured groups. 
				# The first captured group is used as the value for the $fastcgi_script_name variable. 
				# The second captured group is used as the value for the $fastcgi_path_info variable. 
				fastcgi_split_path_info ^(.+\.php)(/.+)$;
				# the actual directive (service) that passes requests in the current context to the backend.
				fastcgi_pass wordpress;
				# this defines the index file that should be appended to $fastcgi_script_name values that end with a slash (/).
				# This is often useful if the SCRIPT_FILENAME parameter is set to $document_root$fastcgi_script_name and 
				# the location block is configured to accept requests with info after the file.
				fastcgi_index index.php;
				# fastcgi_param is used in conjunction with Nginx variables to set FastCGI parameters 
				include fastcgi_params;
				fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
				fastcgi_param SCRIPT_NAME $fastcgi_script_name;
			}
	}
}

